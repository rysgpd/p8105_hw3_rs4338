---
title: "p8105_hw3_rs4338"
author: "Rebecca Shyu"
date: "2024-10-08"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(haven)
library(kableExtra)
library(leaflet)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 8,
  fig.asp = .6,
  out.width = "100%",
	dpi=300
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

## Problem 0:

* Create a public GitHub repo + local R Project: p8105_hw3_rs4338
* Create a single .Rmd file named p8105_hw3_rs4338.Rmd that renders to github_document
* Create a subdirectory (data) to store the local data files, and use relative paths to access these data files
* Submit a link to your repo via Courseworks: https://github.com/rysgpd/p8105_hw3_rs4338

## Problem 1:

* Extra practice on own.

## Problem 2:

```{r problem2_importdata, message=FALSE}

nhanes_demo = read_csv("data/nhanes/nhanes_covar.csv", 
                       skip = 4) %>% 
  janitor::clean_names() %>% 
  drop_na() %>% 
  filter(
    age >= 21
  ) %>% 
  mutate(
    sex = ifelse(sex == 1, "Male", "Female"),
    education = 
      case_match(
        education,
        1 ~ "Less than high school",
        2 ~ "High school equivalent",
        3 ~ "More than high school"
      ),
    education = factor(education, levels = c("Less than high school", "High school equivalent", "More than high school"))
  ) 

nhanes_acc_data = read_csv("data/nhanes/nhanes_accel.csv", show_col_types = FALSE) %>%
  janitor::clean_names() %>% 
  distinct() %>% 
  pivot_longer(
    cols = min1:min1440,
    names_to = "minute",
    values_to = "mims_data",
    names_prefix = "min"
  ) %>% 
  mutate(minute = as.numeric(minute))

# join the demographic and accelerometer datasets
nhanes = inner_join(nhanes_demo, nhanes_acc_data, by="seqn")
# there are 22 patients who don't have any demographic data
```

Reader friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category.

* I decided to use a density plot to visualize the age distributions for men and women in each education category because the histogram was not easily interpretable and rigid. I overlapped the density plots for men and women to easily compare them. 
* It appears that the distributions across all educational levels for men are bi-modal while women are unimodal. 
* For the less than high school education level, it leaned to more older populations for both men and women.
* For the high school equivalent education level, it looked like a steady incline for women and it peaked around age 70. For men, it was pretty consistent throughout and then declined after age 60. 
* For the more than high school education level, women had up to 0.025 density around age 30, which shows more education among younger women. Similarly, but not as high in comparison to women, younger men were higher than older men. 

```{r prob2_genderedu}

nhanes %>% 
  distinct(seqn, .keep_all = TRUE) %>%
  group_by(education, sex) %>% 
  count() %>% 
  arrange(education) %>% 
  knitr::kable(col.names = c("Education", "Sex", "Number of Participants"), caption = "NHANES Accelerometer Demographics Breakdown") %>% 
  collapse_rows(columns = 1)

nhanes %>% 
  distinct(seqn, .keep_all = TRUE) %>%
  group_by(education, sex) %>% 
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = .3) +
  facet_grid(. ~ education) +
  labs(
    title = "Density Plots of Ages Across Genders & Education Levels",
    x = "Age (Years)",
    y = "Density"
    ) +
  theme(plot.title = element_text(hjust = 0.5))

```

Comments about the Total Activity Across Ages, comparing men and women and for each education level:

* For all education levels and both sexes, there is a generally downward trend of total activity (minutes) measured. There are a few exceptions that have slight peaks around ages 60 (less than high school for both, more than high school for men) or 70 (high school equivalent).
* For high school equivalent and more than high school, women are almost always higher than men. For less than high school, younger women have higher activity until age 40, then the men have higher total activity. 
* The trend lines start at the highest for less than high school, but ends at the lowest also for the less than high school level. More than high school seems to have less variability in general, but has the most extreme outliers. 


```{r prob2_total_activity, message=FALSE}

nhanes = 
  nhanes %>% 
  group_by(seqn) %>% 
  mutate(
    total_activity = sum(mims_data)
  )

nhanes %>% 
  distinct(seqn, .keep_all = TRUE) %>% 
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = .8) +
  geom_smooth(se = FALSE) +
  facet_grid(. ~ education) +
  labs(
    title = "Scatterplots of Ages x Total Activity Across Education Levels",
    x = "Age (Years)",
    y = "Total Activity (MIMS-Unit)",
    colour="Gender" 
    ) +
  theme(plot.title = element_text(hjust = 0.5))
```

Accelerometer Data Over 24 Hours for each education level and across sexes.

* From the plot below, it looks like both female and male populations for each education level showed very similar trends and patterns. 
  * Especially for the Less than high school level, those lines are practically the same.
  * For the other two, women seem to have a slightly higher MIMS level for the entire day until the end when the lines converge again.
  * The most separation is in the more than high school group.
* It's a general pattern where most people have low MIMS activity at the beginning/midnight (first 250 minutes), which makes sense because the activity begins to pick up quickly when people start to wake up. 
* For less than high school, the peak is around noon and slowly goes down after that until the sharp drop off around 10 pm. The high school equivalent level has a more stable pattern and stays pretty stagnant until a little earlier than the less than high school group. Lastly, the more than high school level has a little higher plateau than the rest of the levels and similarly dips at the time that high school equivalent does. 
* Lastly, the range for more than high school is the largest out of the three. Women seem to have more activity in the morning, while men have more activity in the evening. These go up to about 80 MIMS units.

```{r prob2_acceldata_24hours, eval=FALSE, message=FALSE}

nhanes %>% 
  ggplot(aes(x = minute, y = mims_data, color = sex)) +
  geom_point(size = 0.001, alpha = 0.2) +
  geom_smooth(se = FALSE, linewidth=0.5) +
  facet_grid(. ~ education) +
  labs(
    title = "24 Hour Accelerometer Data Across Education Levels by Sex",
    x = "Time (Minutes)",
    y = "Monitor-Independent Movement Summary (MIMS-unit)",
    colour="Gender"
    ) +
  theme(plot.title = element_text(hjust = 0.5))

```


## Problem 3: Citi Bikes

```{r prob3_import, message=FALSE}
citi_bike_jan2020 = read_csv("data/citibike/Jan 2020 Citi.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    year = 2020,
    month = "January")

citi_bike_jan2024 = read_csv("data/citibike/Jan 2024 Citi.csv") %>% 
  janitor::clean_names()%>% 
  mutate(
    year = 2024,
    month = "January")

citi_bike_july2020 = read_csv("data/citibike/July 2020 Citi.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    year = 2020,
    month = "July")

citi_bike_july2024 = read_csv("data/citibike/July 2024 Citi.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    year = 2024,
    month = "July")


citi_bike = 
  bind_rows(citi_bike_jan2020, citi_bike_july2020, citi_bike_jan2024, citi_bike_july2024) %>% 
  relocate(
    year, month
  ) %>% 
  mutate(
    weekdays = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
  )

#colSums(is.na(citi_bike))
```

Describing the resulting dataset: 

* This dataset has `r citi_bike %>% count()` unique rides after combining all four data files. There are `r citi_bike %>% filter(year == 2020) %>% count()` and `r citi_bike %>% filter(year == 2024) %>% count()` rides in the months of January/July of 2020 and 2024 respectively. 
* There are `r citi_bike %>% filter(member_casual == "member") %>% count()` member rides total and `r citi_bike %>% filter(member_casual == "casual") %>% count()` casual rides total. 
* The range of duration is from `r citi_bike %>% pull(duration) %>% min()` to `r citi_bike %>% pull(duration) %>% max()` minutes.
* There are 43 rides without a start_station_name and 207 rides without an end_station_name. I have decided to keep these rides in the dataset because there are many questions that don't involve the station names, and all other variables are included. 

A reader-friendly table for the total number of rides in each combination of year and month (January 2020, July 2020, January 2024, and July 2024). 

* This table shows that for each year/month combination, the number of member rides were overwhelmingly more than casual rides. By July 2024, there were about 3x as many member rides than casual. 
* The number of rides from each year and month increased each time for both rider groups except for between July 2020 and January 2024 - casual rides decreased and member rides barely increased. This, however, does make sense because of the weather conditions, alongside more visitors, that make biking more enjoyable in the summer than winter months. 
* The number of rides in July 2024 was almost 50,000 which shows how popular Citi Biking has become in New York City. 

```{r prob3_year_month_combos}

citi_bike %>% 
  group_by(year, month, member_casual) %>% 
  count() %>% 
  arrange(year) %>% 
  knitr::kable(col.names = c("Year", "Month", "Rider Type", "Number of Riders"), caption = "Citi Bike Rides by Year, Month, and Rider Type") %>% 
  collapse_rows(columns = c(1,2))
```

Here are the top 5 popular starting stations for July 2024. 

* The most popular station is Pier 61 at Chelsea Piers, with 163 rides originating there.

``` {r prob3_top5_start_stations}
citi_bike %>% 
  filter(
    year == 2024,
    month == "July"
  ) %>% 
  group_by(start_station_name) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  head(5) %>% 
  knitr::kable(col.names = c("Starting Station", "Number of Rides Originating Here"), caption = "The 5 Most Popular Starting Citi Bike Stations of July 2024")
```

Looking at the effects of the day of the week, month, and year on median ride duration:

```{r}

citi_bike %>% 
  group_by(weekdays) %>% 
  summarize(median = median(duration))


  ggplot(aes(x = weekdays, y = duration, fill = weekdays)) +
  geom_boxplot() +
  facet_grid(month ~ year)

citi_bike %>% 
  ggplot(aes(x = weekdays, y = duration, fill = weekdays)) +
  geom_boxplot() +
  facet_grid(month ~ year)


```


